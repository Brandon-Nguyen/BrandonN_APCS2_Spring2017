//Brandon Nguyen, 2nd Period
package textExcel;

import java.util.Arrays;

public class FormulaCell extends RealCell{
	
	private String formula;
	private Cell[][] grid;

	public FormulaCell(String formula, Cell[][] spreadsheet) {
		// TODO Auto-generated constructor stub
		this.formula = formula;
		this.grid = spreadsheet;
		setRealCell(formula);
	}

	
	//broken here, fix here.....
	public double getDoubleValue(){
		String input = getRealCell().substring(2, getRealCell().length() - 2);
		String[] formula = input.split(" ");
		
		if(formula.length == 1){
			return Double.parseDouble(formula[0]);
			
		}else if((formula[0].toUpperCase().equals("AVG")) || (formula[0].toUpperCase().equals("SUM"))){
			
			String cell = formula[1].toUpperCase().substring(0, formula[1].indexOf('-'));
			String ending = formula[1].toUpperCase().substring(formula[1].indexOf('-') + 1);

			if(formula[0].toUpperCase().equals("AVG")){
			
				return (sum(cell, cell, ending)) / count(cell, ending);
			}else{
				return (sum (cell, cell, ending));
			}
			
		}else{
		
			
			for(int i = 0; i < formula.length; i += 2 ){
				if(formula[i].toUpperCase().charAt(0) >= 'A' && formula[i].toUpperCase().charAt(0) <='L'){
					SpreadsheetLocation cell = new SpreadsheetLocation(formula[i].toUpperCase());
					if(grid[cell.getRow()][cell.getCol()] instanceof RealCell){
						formula[i] = Double.toString(((RealCell)grid[cell.getRow()][cell.getCol()]).getDoubleValue());
					}else{
						formula[i] = "0.0";
					}
				}
			}
			
			double sum;
			if(formula[0].toUpperCase().charAt(0) >= 'A' && formula[0].toUpperCase().charAt(0) <='L'){
				formula[0] = formula[0].toUpperCase();
				//System.out.println(formula[i]);
				SpreadsheetLocation cell = new SpreadsheetLocation(formula[0]);
				if(grid[cell.getRow()][cell.getCol()] instanceof RealCell){
					sum = ((RealCell)grid[cell.getRow()][cell.getCol()]).getDoubleValue();
				}else{
					sum = 0.0;
				}
			}else{
				sum = Double.parseDouble(formula[0]);
			}

			for(int i = 1; i < formula.length - 1; i += 2 ){

				if(formula[i].equals("*")){
					sum *=  Double.parseDouble(formula[i+1]);
				}else if(formula[i].equals("/")){
					sum /= Double.parseDouble(formula[i+1]);
				}else if(formula[i].equals("+")){
					sum += Double.parseDouble(formula[i+1]);
				}else{
					sum -= Double.parseDouble(formula[i+1]);
				}

				//System.out.println(" :( " + formula[i+2]);
				//System.out.println(" ahhh : " +storeVal);
			}

			return sum;
		}
	}
	
	
	public double sum(String cell, String newCell, String end){	
		
		SpreadsheetLocation loc = new SpreadsheetLocation(newCell);
		
		if(newCell.equals(end)){
			if(grid[loc.getRow()][loc.getCol()] instanceof RealCell){
				return ((RealCell)grid[loc.getRow()][loc.getCol()]).getDoubleValue();
			}else{
				return 0.0;
			}
		}
		
		if(Character.toUpperCase(cell.charAt(0)) != Character.toUpperCase(end.charAt(0)) 
				&& Integer.parseInt(cell.substring(1)) == Integer.parseInt(end.substring(1))){
			newCell = ((char)(newCell.charAt(0) + 1)) + cell.substring(1);
			
		}else if( Character.toUpperCase(cell.charAt(0)) == Character.toUpperCase(end.charAt(0))
				&& Integer.parseInt(cell.substring(1)) <= Integer.parseInt(end.substring(1))){
			
			newCell = Character.toString(cell.charAt(0)) + (Integer.parseInt(newCell.substring(1)) + 1);
			
		}else{
			
			if(Integer.parseInt(newCell.substring(1)) < Integer.parseInt(end.substring(1))){
				
				newCell = Character.toString(newCell.charAt(0)) + (Integer.parseInt(newCell.substring(1)) + 1);

				
			}else if(Integer.parseInt(newCell.substring(1)) == Integer.parseInt(end.substring(1))){
				
				newCell = ((char)(newCell.charAt(0) + 1)) + "" + 1;
				
			}else{
				newCell = ((char)(newCell.charAt(0) + 1)) + "" + cell.substring(1);
				
			}
		}

		double first;
		if(grid[loc.getRow()][loc.getCol()] instanceof RealCell){
			 first = ((RealCell)grid[loc.getRow()][loc.getCol()]).getDoubleValue();
			return (first + sum(cell, newCell, end));
		}else{
			return sum(cell, newCell, end);
		}
	}
	
	public double count(String startCell, String endCell){
		double count = 0.0;

		int startRow = Integer.parseInt(startCell.substring(1));
		int startCol = (startCell.toUpperCase().charAt(0) - 'A');
		int endRow = Integer.parseInt(endCell.substring(1));
		int endCol = (endCell.toUpperCase().charAt(0) - 'A');
		
		for(int i = startCol; i <= endCol; i++ ){
			
			if(startCol != endCol){
				for(int j = startRow; j <= 20; j++){
					SpreadsheetLocation loc = new SpreadsheetLocation(i + "" + j);
					//System.out.println((int)i - 'A' + "" + j);
					if(grid[loc.getRow()][loc.getCol()] instanceof RealCell){
						count++;
					}
					//System.out.println("count" + count);
				}
				startRow = 1;
			}else{
				for(int j = startRow; j <= endRow; j++){
					SpreadsheetLocation loc = new SpreadsheetLocation(i + "" + j);
					if(grid[loc.getRow()][loc.getCol()] instanceof RealCell){
						count++;
					}
					//System.out.println("count" + count);
				}
			}
		}
		return count;
	}
}
