//Brandon Nguyen, 2nd Period
package textExcel;

public class FormulaCell extends RealCell{
	
	private String formula;
	private Cell[][] grid;

	public FormulaCell(String formula, Cell[][] spreadsheet) {
		// TODO Auto-generated constructor stub
		this.formula = formula;
		this.grid = spreadsheet;
		setRealCell(formula);
	}

	public double getDoubleValue(){
		String[] formula = getRealCell().split(" ");
		if(formula.length == 3){
			//System.out.println(formula[1]);
			return Double.parseDouble(formula[1]);
		}
		if((formula[1].equals("avg")) || (formula[1].equals("SUM"))){
			
			double count = 1.0;
			int startRow = Integer.parseInt(formula[2].substring(1));
			int startCol = formula[2].charAt(0) + 'A';
			int endRow = Integer.parseInt(formula[4].substring(1));
			int endCol = formula[4].charAt(0) + 'A';
			for(int i = startCol; i <= endCol; i++ ){
				if(startCol != endCol){
					for(int j = startRow; j <= 20; j++){
						count++;
					}
					startRow = 0;
				}else{
					for(int j = startRow; j <= endRow; j++){
						count++;
					}
				}
			}
			
			if(formula[1].equals("avg")){
				return avg(formula[2], 0.0, count, formula[4]);
			}
			/*}else{
				return sum();
			}*/

		//}else if(){
			
		}else{
			double storeVal = 0.0;
			for(int i = 1; i < formula.length - 2; i += 2 ){
				double num = 0.0;
				double secondNum = 0.0;
				if(formula[i].contains("[a-zA-Z]+") || formula[i + 2].contains("[a-zA-Z]+")){
					if(formula[i].contains("[a-zA-Z]+")){
						System.out.println(formula[i]);
						SpreadsheetLocation cell = new SpreadsheetLocation(formula[i]);
						num = Double.parseDouble(grid[cell.getRow()][cell.getCol()].fullCellText());
						System.out.println(num);
					}else{
						SpreadsheetLocation cell = new SpreadsheetLocation(formula[i + 2]);
						System.out.println(formula[i + 2]);
						secondNum = Double.parseDouble(grid[cell.getRow()][cell.getCol()].fullCellText());
						System.out.println(secondNum);
					}
				}else{
					num = Double.parseDouble(formula[i]);
					System.out.println(num);
					secondNum = Double.parseDouble(formula[i + 2]);
					System.out.println(secondNum);
				}
				
				if(formula[i + 1].equals("*")){
					storeVal += num * secondNum;
				}else if(formula[i + 1].equals("/")){
					storeVal += num / secondNum;
				}else if(formula[i + 1].equals("+")){
					storeVal += num + secondNum;
				}else{
					storeVal += num - secondNum;
				}
				//formula[i+2] = Double.toString(storeVal);
				System.out.println(formula[i+2]);
				System.out.println(storeVal);
			}
			return storeVal;
		}
		return 0.0;
	}
	
	public double avg(String cell, double sum, double count, String end){
		SpreadsheetLocation loc = new SpreadsheetLocation(cell);
		if(cell.equals(end)){
			SpreadsheetLocation area = new SpreadsheetLocation(end);
			sum += Double.parseDouble(grid[loc.getRow()][loc.getCol()].fullCellText())
					* Double.parseDouble(grid[area.getRow()][area.getCol()].fullCellText());
			sum = sum / count;
			return sum;
		}else{
			double first = 
					Double.parseDouble(grid[loc.getRow()][loc.getCol()].fullCellText());
			double second = 
					Double.parseDouble(grid[loc.getRow() + 1][loc.getCol() + 1].fullCellText());
			sum += first * second;
			return sum;
			
		}
		
	}
}
